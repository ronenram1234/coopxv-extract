# ============================================================================
# CoopXV-Extract Project Rules for AI Assistants
# Version: 2.0
# Last Updated: 2026-02-18
# ============================================================================

# PROJECT TYPE
# Node.js plain JavaScript (CommonJS) standalone Windows service
# Packages as single executable with embedded Node.js runtime via pkg

# ============================================================================
# FOLDER STRUCTURE (LOCKED - DO NOT MODIFY)
# ============================================================================

## Root Level
# ONLY these folders allowed at root:
# - config/       (configuration & logger)
# - models/       (Mongoose schemas)
# - scripts/      (scanner, cleanup, setup, utilities)
# - logs/         (auto-created at runtime)
# - dist/         (auto-created, pkg output + WinSW)
# - node_modules/ (auto-created)

## Actual Structure
config/
  database.js        # Loads .env, validates MongoDB URI, exports config values
  logger.js          # Winston logger: daily file rotation + console + MongoDB transport

models/
  Scan.js            # Scan metadata schema (statistics, filesProcessed[], duration)
  ExtractedLine.js   # Extracted row schema (data{}, display{}, metadata{})

scripts/
  scan-and-log.js    # Core scanner: walkSync, pattern matching, Excel reading, dedup, DB insert
  cleanup-old-scans.js  # Deletes scans + extracted_lines older than LOG_RETENTION_DAYS
  setup-env.js       # Interactive .env setup wizard
  test-connection.js # Standalone MongoDB connection test

index.js             # Entry point: MongoDB connect, scan loop, graceful shutdown

# ============================================================================
# NAMING CONVENTIONS (MANDATORY)
# ============================================================================

## Files and Folders
- Folders: kebab-case (e.g., config/)
- JavaScript files: kebab-case.js or PascalCase.js for models (e.g., scan-and-log.js, Scan.js)
- Config files: kebab-case or dot-files (e.g., .env, database.js)

## Code Elements
- Classes: PascalCase (e.g., Scan, ExtractedLine)
- Functions: camelCase (e.g., runScan, walkSync)
- Constants: SCREAMING_SNAKE_CASE (e.g., MAX_RETRY_COUNT)
- Variables: camelCase (e.g., filePattern, scanNumber)

## Module Pattern
- Use `require()` and `module.exports` (CommonJS)
- Do NOT use `import` / `export` (ES modules)
- Group requires: external libraries first, then internal modules

# ============================================================================
# FILE SIZE LIMITS (CRITICAL)
# ============================================================================

## Maximum Line Counts (executable code only)
- Scripts (scripts/*.js): 250 lines
- Models (models/*.js): 150 lines
- Config files (config/*.js): 100 lines
- Main index.js: 150 lines

## Counting Rules
- Count ONLY executable code
- Exclude: headers, comments, blank lines
- Include: require statements, function bodies

## Enforcement
- BEFORE modifying ANY file: Check current line count
- Calculate: Current + Planned Addition = Projected
- If Projected > 80% of limit: Consider splitting proactively
- If Projected > 100% of limit: MUST split before proceeding

# ============================================================================
# MODIFICATION HEADERS (MANDATORY)
# ============================================================================

## Every Modified File Must Have
/**
 * CoopXV-Extract Modification Record
 *
 * File: [filename]
 * Created: [YYYY-MM-DD]
 * Modified: [YYYY-MM-DD]
 * Modified By: [tool name]
 *
 * Description:
 * [Clear explanation of file purpose and recent changes]
 *
 * File Size Check:
 * - Current: [N] lines
 * - Adding: ~[N] lines
 * - Projected: [N] lines
 * - Limit: [N] lines
 * - Decision: [Proceed | Split First]
 *
 * Dependencies:
 * - [List required modules]
 */

## Header Placement
- Must be at line 1
- Never delete old headers - stack newest modifications on top
- Update "Modified" date and description on each change

# ============================================================================
# CODE QUALITY RULES
# ============================================================================

## Error Handling
- All async operations must have try-catch
- Log all errors using logger (never console.log in production code)
- MongoDB connection failures: Infinite retry with logging
- File lock errors: Retry with exponential backoff (max 5 attempts)

## Environment Variables
- ALL configuration from environment variables via config/database.js
- NO hardcoded values (paths, URLs, credentials, timeouts)
- Provide defaults in config/database.js where appropriate

# ============================================================================
# MONGODB RULES
# ============================================================================

## Schema Design
- Use Mongoose schemas for all collections
- Include timestamps: { timestamps: true }
- Add indexes for frequently queried fields

## Column Storage
- Store ALL Excel columns as key-value pairs
- Use Excel column letters as keys (A, B, C, D...)
- Do NOT skip columns or apply mapping logic here
- Both raw values (data{}) and formatted display values (display{}) stored per row

## Connection Handling
- Implement infinite retry on connection failure
- Log each retry attempt with delay
- Use exponential backoff (starting at 5 seconds)
- Never give up trying to reconnect

# ============================================================================
# EXCEL FILE PROCESSING RULES
# ============================================================================

## File Detection
- Pattern: *.xlsx (configurable via FILE_PATTERN env var)
- Scan recursively from ROOT_DIRECTORY
- Use walkSync for file discovery (not file watching)

## Sheet Filter (CRITICAL)
- ONLY extract data from the sheet named "BData_in" (case-insensitive)
- Skip all other sheets entirely
- This prevents extracting data from summary/metadata/other sheets

## Reading Strategy
- Read rows where Column A = 1 (candidate rows for extraction)
- Compare against last stored row to detect new/changed data
- Store timestamp of scan
- Track last processed values to avoid duplicate inserts

## File Locking
- Retry locked files up to 5 times
- Use exponential backoff (2s, 4s, 8s, 16s, 32s)
- Log each retry attempt
- Log final failure if all retries exhausted

# ============================================================================
# LOGGING RULES
# ============================================================================

## Logger Service
- Use Winston for all logging (NO console.log in production code)
- Log to BOTH file and MongoDB (when connected)
- Daily rotation with configurable retention (LOG_RETENTION_DAYS)
- Levels: error, warn, info (default), debug

## Log Format
- Timestamp (ISO 8601, Israel timezone)
- Level
- Message
- Context object (operation, fileName, error, duration)

## What to Log
- INFO: Files scanned, rows processed, data sent
- WARN: File locked, retry attempts, missing files
- ERROR: Connection failures, processing errors, unhandled exceptions

# ============================================================================
# WINDOWS SERVICE RULES
# ============================================================================

## Service Management
- Uses WinSW (Windows Service Wrapper) for service installation
- Service name: CoopXVExtract
- Auto-start: Yes
- Packaged via pkg as single executable (dist/coopxv-extract.exe)

# ============================================================================
# FORBIDDEN ACTIONS
# ============================================================================

## NEVER Do These
- Create new top-level folders beyond the defined structure
- Use console.log in production code (use logger)
- Hardcode configuration values
- Ignore file size limits
- Skip modification headers
- Use ES module syntax (import/export) - use require()/module.exports
- Implement UI components (no UI this phase)
- Extract data from sheets other than BData_in

# ============================================================================
# ALWAYS Do These
# ============================================================================

## Mandatory Actions
- Check file size before modification
- Add modification header to new files
- Update modification header on changes
- Log all significant operations
- Handle all errors with try-catch
- Document business logic decisions with inline comments
- Follow naming conventions exactly
- Use environment variables for config

# ============================================================================
# PROJECT-SPECIFIC TECHNICAL DECISIONS
# ============================================================================

## Confirmed Specifications
- File pattern: *.xlsx (configurable via FILE_PATTERN)
- Sheet filter: BData_in only (case-insensitive)
- Root path: Configurable via ROOT_DIRECTORY
- Scan interval: 5 minutes (configurable via SCAN_INTERVAL_MINUTES)
- MongoDB retry: Infinite with exponential backoff
- Column format: Excel letters (A, B, C...)
- Status column: A (1 = extract this row)
- Cleanup: Daily, configurable retention via LOG_RETENTION_DAYS
- Log rotation: Daily, same retention
- Service auto-start: Yes
- Timezone: Asia/Jerusalem for all timestamps
- UI interface: None (Phase 1)

# ============================================================================
# END OF CURSORRULES
# Enforcement Level: STRICT
# Violations: Must be corrected before proceeding
# ============================================================================
