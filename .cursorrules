# ============================================================================
# CoopXV-Extract Project Rules for Cursor AI
# Version: 1.0
# Last Updated: 2026-01-28
# ============================================================================

# PROJECT TYPE
# Node.js TypeScript standalone Windows service
# Packages as single executable with embedded Node.js runtime

# ============================================================================
# MANDATORY FOLDER STRUCTURE (LOCKED - DO NOT MODIFY)
# ============================================================================

## Root Level
# ONLY these folders allowed at root:
# - src/
# - config/
# - tests/
# - scripts/
# - logs/ (auto-created)
# - dist/ (auto-created)
# - release/ (auto-created)

## Source Structure (src/)
# ENFORCED STRUCTURE:
src/
├── index.ts                    # Main entry point ONLY
├── config/                     # Configuration files only
│   ├── config.ts
│   └── constants.ts
├── services/                   # Business logic services
│   ├── file-watcher.service.ts
│   ├── excel-reader.service.ts
│   ├── mongo.service.ts
│   ├── logger.service.ts
│   ├── queue.service.ts
│   └── cleanup.service.ts
├── models/                     # Mongoose schemas only
│   ├── row-data.model.ts
│   └── process-log.model.ts
├── utils/                      # Pure utility functions
│   ├── file-lock-handler.ts
│   ├── row-tracker.ts
│   └── error-handler.ts
├── types/                      # TypeScript type definitions
│   └── index.ts
├── install-service.ts          # Windows service installer
└── uninstall-service.ts        # Windows service uninstaller

# ============================================================================
# NAMING CONVENTIONS (MANDATORY)
# ============================================================================

## Files and Folders
- Folders: kebab-case (e.g., file-watcher/)
- TypeScript files: kebab-case.ts (e.g., excel-reader.service.ts)
- Config files: kebab-case or dot-files (e.g., .env, default.env)
- Batch scripts: lowercase.bat (e.g., install.bat)

## Code Elements
- Classes: PascalCase (e.g., FileWatcherService)
- Interfaces: PascalCase with "I" prefix (e.g., IRowData)
- Functions: camelCase (e.g., readLastRow)
- Methods: camelCase (e.g., connectWithRetry)
- Constants: SCREAMING_SNAKE_CASE (e.g., MAX_RETRY_COUNT)
- Variables: camelCase (e.g., fileWatcher)
- Enums: PascalCase (e.g., LogLevel)

## Service Files
- Pattern: [name].service.ts
- Export: Single class or singleton instance
- Example: file-watcher.service.ts exports class FileWatcherService

## Model Files
- Pattern: [entity].model.ts
- Export: Mongoose model and interface
- Example: row-data.model.ts exports IRowData interface and RowData model

# ============================================================================
# FILE SIZE LIMITS (CRITICAL)
# ============================================================================

## Maximum Line Counts (executable code only)
- Services (*.service.ts): 200 lines
- Models (*.model.ts): 150 lines
- Utils (*.ts in utils/): 150 lines
- Config files: 100 lines
- Type definitions: 100 lines
- Main index.ts: 150 lines

## Counting Rules
- Count ONLY executable code
- Exclude: headers, comments, blank lines
- Include: imports, type definitions, function bodies

## Enforcement
- BEFORE modifying ANY file: Check current line count
- Calculate: Current + Planned Addition = Projected
- If Projected > 80% of limit: Consider splitting proactively
- If Projected > 100% of limit: MUST split before proceeding

# ============================================================================
# MODIFICATION HEADERS (MANDATORY)
# ============================================================================

## Every Modified File Must Have
/**
 * CoopXV-Extract Modification Record
 *
 * File: [filename]
 * Created: [YYYY-MM-DD]
 * Modified: [YYYY-MM-DD]
 * Modified By: Cursor AI
 *
 * Description:
 * [Clear explanation of file purpose and recent changes]
 *
 * File Size Check:
 * - Current: [N] lines
 * - Adding: ~[N] lines
 * - Projected: [N] lines
 * - Limit: [N] lines
 * - Decision: [Proceed | Split First]
 *
 * Dependencies:
 * - [List imported modules and services]
 */

## Header Placement
- Must be at line 1 (after shebang if present)
- Never delete old headers - stack newest modifications on top
- Update "Modified" date and description on each change

# ============================================================================
# INLINE COMMENTS (MANDATORY FOR SIGNIFICANT CHANGES)
# ============================================================================

## Format
// [YYYY-MM-DD] [topic]: [reason]

## Examples
// [2026-01-28] retry-logic: Infinite retry on MongoDB connection failure per spec
// [2026-01-28] excel-reading: Read last row only for memory efficiency (8.1.B)
// [2026-01-28] column-names: Preserve Excel letter format (A,B,C...) per Q5

## When to Add
- Business logic implementations
- Error handling decisions
- Performance optimizations
- Spec compliance points

# ============================================================================
# CODE QUALITY RULES
# ============================================================================

## TypeScript Strict Mode
- All code MUST pass strict TypeScript checks
- No "any" types without explicit comment explaining why
- All function parameters must be typed
- All return types must be explicit

## Error Handling
- All async operations must have try-catch
- Log all errors using logger service (never console.log)
- MongoDB connection failures: Infinite retry with logging
- File lock errors: Retry with exponential backoff (max 5 attempts)

## Imports
- Group imports: external libraries first, then internal modules
- Use absolute imports from 'src/' when possible
- Sort alphabetically within groups

## Environment Variables
- ALL configuration from environment variables
- NO hardcoded values (paths, URLs, credentials, timeouts)
- Use config service to access environment variables
- Provide defaults in config/default.env

# ============================================================================
# MONGODB RULES
# ============================================================================

## Schema Design
- Use Mongoose schemas for all collections
- Define interfaces for all models (IRowData, IProcessLog)
- Include timestamps: { timestamps: true }
- Add indexes for frequently queried fields

## Column Storage
- Store ALL Excel columns as key-value pairs
- Use Excel column letters as keys (A, B, C, D...)
- Do NOT skip columns or apply mapping logic here
- Mapping logic belongs in consuming services, not extraction

## Connection Handling
- Implement infinite retry on connection failure
- Log each retry attempt with delay
- Use exponential backoff (starting at 5 seconds)
- Never give up trying to reconnect

# ============================================================================
# EXCEL FILE PROCESSING RULES
# ============================================================================

## File Detection
- Pattern: cxv*.xlsx (case-sensitive, lowercase only)
- Scan recursively from C:\CoopXV
- Use Chokidar for file watching (not polling)

## Reading Strategy
- Read ONLY the last row (memory efficiency)
- Check Column A value: 1 = process, 2 = error alert
- Store timestamp of file modification
- Track last processed values to detect new data

## File Locking
- Retry locked files up to 5 times
- Use exponential backoff (2s, 4s, 8s, 16s, 32s)
- Log each retry attempt
- Log final failure if all retries exhausted

# ============================================================================
# LOGGING RULES
# ============================================================================

## Logger Service
- Use Winston for all logging (NO console.log)
- Log to BOTH file and MongoDB (when connected)
- Daily rotation with 30-day retention
- Levels: error, warn, info (default), debug

## Log Format
- Timestamp (ISO 8601)
- Level
- Message
- Context object (operation, fileName, error, duration)

## What to Log
- INFO: Files scanned, rows processed, data sent
- WARN: File locked, retry attempts, missing files
- ERROR: Connection failures, processing errors, unhandled exceptions

# ============================================================================
# SERVICE ARCHITECTURE RULES
# ============================================================================

## Service Pattern
- Each service is a singleton class
- Export instance: export default new ServiceName()
- Services communicate through dependency injection
- No circular dependencies allowed

## Service Responsibilities
- file-watcher: Monitor directories, detect file changes
- excel-reader: Read Excel files, extract last row
- mongo: Handle all MongoDB operations and connection retry
- logger: Centralized logging to file and database
- queue: Process files sequentially using Bull
- cleanup: Daily cron job for log cleanup

## Initialization Order
1. Load configuration
2. Initialize logger
3. Connect to MongoDB (with infinite retry)
4. Start queue service
5. Start file watcher
6. Schedule cleanup service

# ============================================================================
# TESTING RULES
# ============================================================================

## Test Structure
tests/
├── [service-name].test.ts    # Unit tests
└── fixtures/
    └── sample-files/          # Sample Excel files

## Test Requirements
- Use Jest framework
- Mock external dependencies (MongoDB, file system)
- Test error handling paths
- Test retry logic
- Minimum 80% code coverage for services

# ============================================================================
# WINDOWS SERVICE RULES
# ============================================================================

## Service Installation
- Use node-windows package
- Service name: CoopXVExtract
- Auto-start: Yes (Q1 confirmed)
- Run as: Local System account

## Installation Scripts
- install.bat: Check admin, create config, install service
- uninstall.bat: Stop service, uninstall, preserve logs

# ============================================================================
# PACKAGING RULES
# ============================================================================

## PKG Configuration
- Target: node18-win-x64
- Single executable output
- Embed Node.js runtime (no external dependencies)
- Include config templates in assets

## Distribution Package
- coopxv-extract.exe (main executable)
- config/default.env (template)
- install.bat (installer script)
- uninstall.bat (uninstaller script)
- README.txt (instructions)

# ============================================================================
# FORBIDDEN ACTIONS
# ============================================================================

## NEVER Do These
- ❌ Create new top-level folders
- ❌ Use console.log (use logger service)
- ❌ Hardcode configuration values
- ❌ Ignore file size limits
- ❌ Skip modification headers
- ❌ Use "any" type without comment
- ❌ Add code above modification headers
- ❌ Create files outside defined structure
- ❌ Use require() (use ES6 import/export)
- ❌ Implement UI components (no UI this phase)

# ============================================================================
# ALWAYS Do These
# ============================================================================

## ✅ Mandatory Actions
- ✅ Check file size before modification
- ✅ Add modification header to new files
- ✅ Update modification header on changes
- ✅ Use TypeScript strict mode
- ✅ Log all significant operations
- ✅ Handle all errors with try-catch
- ✅ Document business logic decisions
- ✅ Follow naming conventions exactly
- ✅ Use environment variables for config
- ✅ Test error handling paths

# ============================================================================
# COST OPTIMIZATION
# ============================================================================

## Why These Rules Matter
- Smaller files = lower token costs
- Clear structure = fewer refactoring iterations
- Strict typing = fewer debugging sessions
- Good logging = faster issue resolution
- Target: 15-20% reduction in AI assistance costs

# ============================================================================
# WHEN IN DOUBT
# ============================================================================

## Decision Framework
1. Does this follow the folder structure? → If no, stop
2. Does this exceed file size limits? → If yes, split first
3. Is configuration hardcoded? → If yes, use environment variables
4. Is there proper error handling? → If no, add try-catch
5. Are business rules documented? → If no, add comments
6. Will this need UI components? → If yes, defer to future phase

## Ask User When
- Unclear business requirements
- Multiple valid implementation approaches
- Need to modify folder structure
- Need to add new dependencies
- Uncertain about error handling strategy

# ============================================================================
# PROJECT-SPECIFIC TECHNICAL DECISIONS
# ============================================================================

## Confirmed Specifications
- File pattern: cxv*.xlsx (case-sensitive)
- Root path: C:\CoopXV
- Scan interval: 5 minutes
- File lock retry: 5 attempts with exponential backoff
- MongoDB retry: Infinite with 5-second interval
- Column format: Excel letters (A, B, C...)
- Status column: A (1=process, 2=error)
- Cleanup: Daily at 2 AM, 30-day retention
- Log rotation: Daily, 30-day retention
- Service auto-start: Yes
- UI interface: None (Phase 1)

# ============================================================================
# VERSION CONTROL
# ============================================================================

## Git Ignored Items (in .gitignore)
- node_modules/
- dist/
- release/
- logs/
- .env
- *.log

## Tracked Items
- src/ (all source code)
- config/ (templates only)
- tests/ (all test files)
- scripts/ (installation scripts)
- package.json
- tsconfig.json
- .cursorrules (this file)
- README.md

# ============================================================================
# COMPLIANCE VERIFICATION
# ============================================================================

## Before Committing Any Code, Verify
- [ ] Folder structure matches specification
- [ ] File naming follows conventions
- [ ] File sizes under limits
- [ ] Modification headers present
- [ ] TypeScript strict mode passes
- [ ] No console.log statements
- [ ] No hardcoded configuration
- [ ] Error handling implemented
- [ ] Business logic documented
- [ ] Tests written (when applicable)

# ============================================================================
# END OF CURSORRULES
# Enforcement Level: STRICT
# Violations: Must be corrected before proceeding
# ============================================================================
